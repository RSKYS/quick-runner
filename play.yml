---
- name: Server for GitHub Actions Runner
  hosts: actions_server
  become: yes
  vars:
    runner_version: "2.317.0"
    runner_url: "https://github.com/actions/runner/releases/download/v{{ runner_version }}/actions-runner-linux-x64-{{ runner_version }}.tar.gz"

  tasks:
    - name: Update and upgrade all packages
      ansible.builtin.apt:
        update_cache: yes
        upgrade: dist
        autoclean: yes
        autoremove: yes

    - name: Purge unnecessary packages
      ansible.builtin.apt:
        name:
          - snapd
          - needrestart
        state: absent

    - name: Install Docker and Docker Compose
      ansible.builtin.apt:
        name:
          - docker.io
          - docker-compose
        state: present
        force: yes

    - name: Configure actions user
      block:
        - name: Add user actions, set up groups
          ansible.builtin.user:
            name: actions
            create_home: yes
            groups:
              - sudo
              - docker
            append: yes

        - name: Create actions-runner directory
          ansible.builtin.file:
            path: /home/actions/actions-runner
            state: directory
            owner: actions
            group: actions

    - name: Dl & deploy Actions Runner
      block:
        - name: Download actions runner
          ansible.builtin.get_url:
            url: "{{ runner_url }}"
            dest: /home/actions/actions-runner/actions-runner-linux-x64-{{ runner_version }}.tar.gz
            owner: actions
            group: actions

        - name: Extract actions runner
          ansible.builtin.unarchive:
            src: /home/actions/actions-runner/actions-runner-linux-x64-{{ runner_version }}.tar.gz
            dest: /home/actions/actions-runner/
            remote_src: yes
            owner: actions
            group: actions

        - name: Run Actions
          ansible.builtin.shell:
            cmd: |
              sudo -u actions "{{ config_str }}"
              ./svc.sh install
              ./svc.sh stop
              ./svc.sh start
            args:
              chdir: /home/actions/actions-runner
              executable: /bin/bash
